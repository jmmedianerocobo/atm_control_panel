<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Configuración Bluetooth</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Estado de Bluetooth -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="bluetooth-outline"></ion-icon>
        Estado de Conexión
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item>
          <ion-label>Bluetooth</ion-label>
          <ion-badge [color]="isBluetoothEnabled ? 'success' : 'danger'" slot="end">
            {{ isBluetoothEnabled ? 'Habilitado' : 'Deshabilitado' }}
          </ion-badge>
        </ion-item>

        <ion-item>
          <ion-label>Conexión</ion-label>
          <ion-badge [color]="isConnected ? 'success' : 'medium'" slot="end">
            {{ isConnected ? 'Conectado' : 'Desconectado' }}
          </ion-badge>
        </ion-item>

        <ion-item>
          <ion-label>Auto-reconexión</ion-label>
          <ion-toggle 
            [(ngModel)]="autoReconnect" 
            (ionChange)="onAutoReconnectChange($event)"
            slot="end">
          </ion-toggle>
        </ion-item>

        <ion-item *ngIf="connectedDevice">
          <ion-label>
            <h3>Dispositivo Actual</h3>
            <p>{{ connectedDevice.name }}</p>
            <ion-note>{{ connectedDevice.address }}</ion-note>
          </ion-label>
        </ion-item>

        <ion-item *ngIf="isConnected && statistics.connectionTime">
          <ion-icon name="time-outline" slot="start"></ion-icon>
          <ion-label>
            <h3>Tiempo Conectado</h3>
            <p>{{ formatUptime() }}</p>
          </ion-label>
        </ion-item>
      </ion-list>

      <!-- Estado de reconexión -->
      <div *ngIf="isReconnecting" class="reconnecting-banner">
        <ion-spinner name="dots"></ion-spinner>
        <span>Reconectando... ({{ reconnectAttempts }}/{{ maxReconnectAttempts }})</span>
        <ion-button size="small" fill="clear" (click)="cancelReconnection()">
          Cancelar
        </ion-button>
      </div>

      <div style="margin-top: 16px;">
        <ion-button 
          expand="block" 
          *ngIf="!isBluetoothEnabled"
          (click)="enableBluetooth()">
          <ion-icon name="bluetooth-outline" slot="start"></ion-icon>
          Habilitar Bluetooth
        </ion-button>

        <ion-button 
          expand="block" 
          color="danger"
          *ngIf="isConnected"
          (click)="disconnect()">
          <ion-icon name="close-circle" slot="start"></ion-icon>
          Desconectar
        </ion-button>

        <ion-button 
          expand="block" 
          *ngIf="isConnected"
          (click)="sendTestCommand()">
          <ion-icon name="send-outline" slot="start"></ion-icon>
          Enviar Comando de Prueba
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Estadísticas -->
  <ion-card>
    <ion-card-header>
      <ion-card-title style="display: flex; justify-content: space-between; align-items: center;">
        <span>
          <ion-icon name="stats-chart-outline"></ion-icon>
          Estadísticas
        </span>
        <ion-button size="small" fill="clear" (click)="resetStatistics()">
          Reset
        </ion-button>
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <div class="stat-item">
              <ion-icon name="send-outline" color="primary"></ion-icon>
              <div class="stat-content">
                <div class="stat-value">{{ statistics.messagesSent }}</div>
                <div class="stat-label">Enviados</div>
              </div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-item">
              <ion-icon name="download-outline" color="success"></ion-icon>
              <div class="stat-content">
                <div class="stat-value">{{ statistics.messagesReceived }}</div>
                <div class="stat-label">Recibidos</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="6">
            <div class="stat-item">
              <ion-icon name="swap-vertical-outline" color="tertiary"></ion-icon>
              <div class="stat-content">
                <div class="stat-value">{{ statistics.messagesSent + statistics.messagesReceived }}</div>
                <div class="stat-label">Total</div>
              </div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-item">
              <ion-icon name="close-circle" color="danger"></ion-icon>
              <div class="stat-content">
                <div class="stat-value">{{ statistics.errors }}</div>
                <div class="stat-label">Errores</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="6">
            <div class="stat-item">
              <ion-icon name="bluetooth-outline" color="medium"></ion-icon>
              <div class="stat-content">
                <div class="stat-value">{{ statistics.connectionAttempts }}</div>
                <div class="stat-label">Intentos</div>
              </div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-item">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
              <div class="stat-content">
                <div class="stat-value">{{ getSuccessRate() }}%</div>
                <div class="stat-label">Éxito</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Dispositivos Emparejados -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="list-outline"></ion-icon>
        Dispositivos Emparejados
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-button 
        expand="block" 
        fill="outline"
        (click)="loadPairedDevices()"
        [disabled]="!isBluetoothEnabled || isScanning">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        {{ isScanning ? 'Buscando...' : 'Actualizar Lista' }}
        <ion-spinner *ngIf="isScanning" slot="end"></ion-spinner>
      </ion-button>

      <ion-list *ngIf="pairedDevices.length > 0" style="margin-top: 12px;">
        <ion-item 
          *ngFor="let device of pairedDevices"
          [button]="!isConnected"
          [disabled]="isConnected"
          (click)="!isConnected && connectToDevice(device)">
          <ion-icon 
            [name]="connectedDevice?.address === device.address ? 'checkmark-circle' : 'bluetooth-outline'" 
            slot="start"
            [color]="connectedDevice?.address === device.address ? 'success' : 'primary'">
          </ion-icon>
          <ion-label>
            <h3>{{ device.name }}</h3>
            <p>{{ device.address }}</p>
          </ion-label>
          <ion-chip 
            *ngIf="lastDeviceAddress === device.address && !isConnected"
            color="tertiary"
            slot="end">
            <ion-label>Último</ion-label>
          </ion-chip>
          <ion-badge 
            *ngIf="connectedDevice?.address === device.address" 
            color="success" 
            slot="end">
            Conectado
          </ion-badge>
        </ion-item>
      </ion-list>

      <div *ngIf="pairedDevices.length === 0 && !isScanning" style="text-align: center; padding: 20px;">
        <ion-note>No hay dispositivos emparejados</ion-note>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Monitor de Logs -->
  <ion-card>
    <ion-card-header>
      <ion-card-title style="display: flex; justify-content: space-between; align-items: center;">
        <span>
          <ion-icon name="list-outline"></ion-icon>
          Monitor de Actividad
        </span>
        <ion-button size="small" fill="clear" (click)="clearLogs()">
          Limpiar
        </ion-button>
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="logs-container">
        <ion-list *ngIf="logs.length > 0">
          <ion-item *ngFor="let log of logs" lines="none">
            <ion-icon 
              [name]="getLogIcon(log.type)" 
              [color]="getLogColor(log.type)"
              slot="start">
            </ion-icon>
            <ion-label>
              <p style="font-size: 12px;">
                <strong>{{ formatTime(log.timestamp) }}</strong>
              </p>
              <p [style.color]="'var(--ion-color-' + getLogColor(log.type) + ')'">
                {{ log.message }}
              </p>
            </ion-label>
          </ion-item>
        </ion-list>

        <div *ngIf="logs.length === 0" style="text-align: center; padding: 20px;">
          <ion-note>No hay actividad registrada</ion-note>
        </div>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>