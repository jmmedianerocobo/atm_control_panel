<ion-header>
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/distance-view"></ion-back-button>
    </ion-buttons>
    <ion-title>Bluetooth</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- =======================
       ESTADO PRINCIPAL
  ========================== -->
  <div class="status-card" 
       [ngClass]="{
         'state-disconnected': !(isConnected$ | async) && !isConnecting,
         'state-connecting': isConnecting,
         'state-connected': (isConnected$ | async)
       }">

    <div class="status-icon">
      <ion-icon name="bluetooth" *ngIf="!isConnecting"></ion-icon>
      <ion-spinner *ngIf="isConnecting"></ion-spinner>
    </div>

    <div class="status-text">
      <h2 *ngIf="!(isConnected$ | async) && !isConnecting">Desconectado</h2>
      <h2 *ngIf="isConnecting">Conectando…</h2>
      <h2 *ngIf="isConnected$ | async">Conectado</h2>
      <p>{{ (isConnected$ | async) ? 'El dispositivo está listo.' : 'Ningún dispositivo conectado.' }}</p>
    </div>

    <!-- BOTÓN ACCIÓN PRINCIPAL -->
    <ion-button expand="block"
                [color]="(isConnected$ | async) ? 'danger' : 'primary'"
                (click)="toggleConnection()">

      <ng-container *ngIf="!(isConnected$ | async) && !isConnecting">
        Buscar y Conectar
      </ng-container>

      <ng-container *ngIf="isConnecting">
        Cancelar
      </ng-container>

      <ng-container *ngIf="isConnected$ | async">
        Desconectar
      </ng-container>

    </ion-button>
  </div>

  <!-- =======================
       DISPOSITIVOS EMPAREJADOS
  ========================== -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Dispositivos emparejados</ion-card-title>
    </ion-card-header>

    <ion-list>
      <ion-item *ngFor="let dev of pairedDevices$ | async">
        <ion-label>
          <h2>{{ dev.name }}</h2>
          <p>{{ dev.address }}</p>
        </ion-label>

        <ion-button color="primary"
                    [disabled]="isConnected$ | async"
                    (click)="connectTo(dev)">
          Conectar
        </ion-button>
      </ion-item>

      <ion-item *ngIf="(pairedDevices$ | async)?.length === 0">
        <ion-label>No hay dispositivos emparejados.</ion-label>
      </ion-item>
    </ion-list>
  </ion-card>

  <!-- =======================
       BÚSQUEDA NUEVOS DISPOSITIVOS
  ========================== -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Buscar nuevos dispositivos</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-button expand="block" color="secondary"
                  (click)="scan()" [disabled]="isScanning">
        <span *ngIf="!isScanning">Buscar</span>
        <ion-spinner *ngIf="isScanning"></ion-spinner>
      </ion-button>

      <ion-list *ngIf="(unpairedDevices$ | async)?.length! > 0">
        <ion-item *ngFor="let dev of unpairedDevices$ | async">
          <ion-label>
            <h2>{{ dev.name }}</h2>
            <p>{{ dev.address }}</p>
          </ion-label>

          <ion-button color="success" (click)="tryConnect(dev)">
            Emparejar + Conectar
          </ion-button>
        </ion-item>
      </ion-list>

      <ion-item *ngIf="(unpairedDevices$ | async)?.length === 0 && !isScanning">
        <ion-label>No se encontraron dispositivos nuevos.</ion-label>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <!-- =======================
       SENSORES
  ========================== -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Sensores</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <ion-item>
        <ion-label>Izquierda</ion-label>
        <ion-chip color="primary" *ngIf="left$ | async as L">{{ L }} cm</ion-chip>
        <ion-chip color="medium" *ngIf="!(left$ | async)">N/A</ion-chip>
      </ion-item>

      <ion-item>
        <ion-label>Derecha</ion-label>
        <ion-chip color="primary" *ngIf="right$ | async as R">{{ R }} cm</ion-chip>
        <ion-chip color="medium" *ngIf="!(right$ | async)">N/A</ion-chip>
      </ion-item>

      <ion-button expand="block" color="medium"
                  [disabled]="!(isConnected$ | async)"
                  (click)="requestStatus()">
        Actualizar estado
      </ion-button>
    </ion-card-content>
  </ion-card>

</ion-content>



