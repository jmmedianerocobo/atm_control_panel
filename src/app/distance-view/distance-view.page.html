<ion-header>
  <ion-toolbar>
    <ion-title>ATM Control Panel</ion-title>

    <ion-buttons slot="start">
      <ion-back-button defaultHref="/distance-view"></ion-back-button>
    </ion-buttons>

    <ion-buttons slot="end">

      <!-- Configuración -->
      <ion-button (click)="openConfigPage()" fill="clear">
        <ion-icon src="/assets/icon/settings-outline.svg"></ion-icon>
      </ion-button>

      <!-- Bluetooth -->
      <ion-button (click)="goToBluetoothSettings()" color="primary" fill="clear">
        <ion-icon src="/assets/icon/bluetooth-outline.svg" class="bt-icon"></ion-icon>
      </ion-button>

      <!-- Salir App -->
      <ion-button (click)="exitApp()" fill="clear" color="danger">
        <ion-icon src="/assets/icon/power-outline.svg"></ion-icon>
      </ion-button>

      <!-- Estado conexión -->
      <ion-chip [color]="(isConnected$ | async) ? 'success' : 'danger'">
        <ion-label>
          {{ (isConnected$ | async) ? 'Conectado' : 'Desconectado' }}
        </ion-label>
      </ion-chip>

    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Capturamos relayStats UNA sola vez para toda la página -->
  <ng-container *ngIf="relayStats$ | async as stats">

    <div class="two-column-container">

      <!-- ================= LEFT ================= -->
      <div class="column panel-container">
        <div class="panel-header header-with-toggle">
          <span>Lado Izquierdo</span>

          <ion-toggle
            class="custom-toggle"
            color="success"
            [checked]="(enabledLeft$ | async) === true"
            (ionChange)="onToggleLeft($event)">
          </ion-toggle>
        </div>

        <div class="panel-body">

          <div class="info-block"
               [ngClass]="{
                 'active-spray': (relayLeft$ | async) === true,
                 'inactive-spray': (relayLeft$ | async) === false
               }">

            <label>Distancia</label>

            <div class="distance-row">
              <div class="distance-value">
                <ng-container *ngIf="distanceLeft$ | async as distLeft; else noLeft">
                  {{ distLeft }} cm
                </ng-container>
                <ng-template #noLeft>--</ng-template>
              </div>

              <div class="spray-icon-mini"
                   [ngClass]="{
                     'active': (relayLeft$ | async) === true,
                     'hidden': (relayLeft$ | async) === false
                   }">
                <img src="assets/icon/spray_izda_transp.svg" />
              </div>
            </div>
          </div>

          <!-- Tiempo apertura -->
          <div class="info-block">
            <label>
              Tiempo en Apertura
              <span *ngIf="(relayLeft$ | async) === true" class="live-indicator">●</span>
            </label>

            <div class="value" [class.live-value]="(relayLeft$ | async) === true">
              {{ formatMsToMinSec(stats?.L?.timeMs) }}
            </div>
          </div>

          <div class="info-block">
            <label>Número de Aperturas</label>
            <div class="value">
              {{ stats?.L?.activations ?? 0 }}
            </div>
          </div>

        </div>
      </div>

      <!-- ================= RIGHT ================= -->
      <div class="column panel-container">
        <div class="panel-header header-with-toggle">
          <span>Lado Derecho</span>

          <ion-toggle
            class="custom-toggle"
            color="success"
            [checked]="(enabledRight$ | async) === true"
            (ionChange)="onToggleRight($event)">
          </ion-toggle>
        </div>

        <div class="panel-body">

          <div class="info-block"
               [ngClass]="{
                 'active-spray': (relayRight$ | async) === true,
                 'inactive-spray': (relayRight$ | async) === false
               }">

            <label>Distancia</label>

            <div class="distance-row">
              <div class="distance-value">
                <ng-container *ngIf="distanceRight$ | async as distRight; else noRight">
                  {{ distRight }} cm
                </ng-container>
                <ng-template #noRight>--</ng-template>
              </div>

              <div class="spray-icon-mini"
                   [ngClass]="{
                     'active': (relayRight$ | async) === true,
                     'hidden': (relayRight$ | async) === false
                   }">
                <img src="assets/icon/spray_dcha_transp.svg" />
              </div>
            </div>
          </div>

          <!-- Tiempo apertura -->
          <div class="info-block">
            <label>
              Tiempo en Apertura
              <span *ngIf="(relayRight$ | async) === true" class="live-indicator">●</span>
            </label>

            <div class="value" [class.live-value]="(relayRight$ | async) === true">
              {{ formatMsToMinSec(stats?.R?.timeMs) }}
            </div>
          </div>

          <div class="info-block">
            <label>Número de Aperturas</label>
            <div class="value">
              {{ stats?.R?.activations ?? 0 }}
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- ================= TOTAL ================= -->
    <div class="total-container">

      <div class="total-panel">
        <span>Total Aplicado</span>

        <strong>
          <ng-container *ngIf="mode$ | async as mode; else modo0">

            <!-- MODO 1 -->
            <ng-container *ngIf="mode === 1; else modo0">
              <ng-container *ngIf="grPerSec$ | async as grps">
                {{
                  (((stats?.L?.timeMs ?? 0) + (stats?.R?.timeMs ?? 0)) / 1000) * grps/1000
                  | number:'1.2-2'
                }} Kg
                
              </ng-container>
            </ng-container>

          </ng-container>

          <!-- MODO 0 -->
          <ng-template #modo0>
            <ng-container *ngIf="litersPerMin$ | async as lpm">
              <ng-container *ngIf="numApplicators$ | async as apps">
                {{
                  (((stats?.L?.timeMs ?? 0) + (stats?.R?.timeMs ?? 0)) / 1000)
                  * (lpm * (apps || 1) / 60)
                  | number:'1.2-2'
                }}
                L
              </ng-container>
            </ng-container>
          </ng-template>

        </strong>
      </div>

      <div class="reset-panel">

        <ion-button
          color="primary"
          fill="solid"
          (click)="bt.requestRelayStats()"
          title="Forzar lectura inmediata de estadísticas">
          <ion-icon slot="start" name="refresh-outline"></ion-icon>
          Refrescar Stats
        </ion-button>

        <ion-button
          color="danger"
          fill="solid"
          (click)="onResetStats()"
          title="Poner a cero tiempo de apertura y número de aperturas">
          <ion-icon slot="start" name="trash-outline"></ion-icon>
          Reset Stats
        </ion-button>

      </div>

    </div>

  </ng-container>

  <!-- ================= AUTO UPDATE ================= -->
  <div class="auto-update-info" *ngIf="isConnected$ | async">
    <ion-chip color="success" outline="true">
      <ion-icon name="sync-outline"></ion-icon>
      <ion-label>Actualización automática cada 2s</ion-label>
    </ion-chip>
  </div>

</ion-content>
